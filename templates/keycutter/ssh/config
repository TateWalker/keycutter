# ~/.keycutter/ssh/config
#
# SSH Config file for keycutter
#
# Sourced by the following line in ~/.ssh/config (added by keycutter):
#
#   Include ~/.keycutter/ssh/config

# SSH Agent Management: Define multiple agents for different purposes
#
# 1. SSH access to git: the only thing you'll need ssh-agent forwarding for.
# 2. Use SSH ProxyJump instead for bastion hopping
# 3. Same proxy is used locally and shared with remote hosts.
# 4. You don't need to use the SSH agent from local host
# 5. You probably only need git ssh keys on the your ssh-agent(s)
# 6. Hopping around from box to box can be fun. Feel free to add more keys!

# LC_KEYCUTTER_ORIGIN
#
# - Environment variable containing hostname of "origin" machine.
# - Defines whether Identityfile should reference private or public keys (for ssh-agent).
# - By default, sshd only permits SendEnv with to use LANG, LC_*, and TERM.
#
# You need to set this in your shell profile or similar:
#
#   export LC_KEYCUTTER_ORIGIN="$(hostname -s)"

SendEnv LC_KEYCUTTER_ORIGIN

Match exec "bash -c '[[ $LC_KEYCUTTER_ORIGIN -eq %l ]]'" # Connecting from Origin
    Tag origin

# Match exec "bash -c '[[ -n $SSH_CONNECTION ]]'" # Not on remote hosts
Match exec "bash -c '[[ $LC_KEYCUTTER_ORIGIN -ne %l ]]'" # Not on remote hosts
    Tag remote

# Setup default ssh-agent with private keys indicated by symlinks
Match tagged origin
    PermitLocalCommand yes
    LocalCommand /bin/bash -c '~/keycutter/bin/ssh-agent-ensure ~/.keycutter/ssh/agents/default'
    IdentityAgent ~/.keycutter/ssh/agents/default/ssh-agent.socket

# Key name = Host, connecting from origin host
Match tagged hostnamekey tagged origin
# exec "bash -c '[[ $LC_KEYCUTTER_ORIGIN -eq %l ]]'"
    IdentityFile ~/.keycutter/ssh/keys/%k@${LC_KEYCUTTER_ORIGIN}
    IdentityFile ~/.keycutter/ssh/keys/%k@keyring

# Key name = host, connecting from remote host
Match tagged hostnamekey tagged remote
# exec "bash -c '[[ $LC_KEYCUTTER_ORIGIN -ne %l ]]'"
    IdentityFile ~/.keycutter/ssh/keys/%k@${LC_KEYCUTTER_ORIGIN}.pub
    IdentityFile ~/.keycutter/ssh/keys/%k@keyring.pub

# Catchall to handle all github.com_<username> hosts
Host *github.com_*
    Tag hostnamekey
    User git
    HostName github.com

    # To get around pesky firewalls that block port 22
    # - Comment out the previous HostName line and uncomment the following lines
    # HostName ssh.github.com
    # Port 443

    PermitLocalCommand no # Don't start an ssh-agent
    ForwardAgent no       # Don't forward an ssh-agent

    IdentitiesOnly yes

# Define your custom hosts here
Host *
    Include ~/.keycutter/ssh/hosts/*
