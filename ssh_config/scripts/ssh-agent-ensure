#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

host="${1:-}"

socket=$(ssh -G "$host" 2>/dev/null | awk '/^identityagent / {print $2}')
[[ -n $socket ]] || exit 0

agent_dir=$(dirname "$socket")

export SSH_AUTH_SOCK="$socket"

if [[ ! -S "$socket" ]] || ! ssh-add -l &>/dev/null; then
    rm -f "$socket"
    ssh-agent -a "$socket" > /dev/null
fi

ssh-add -D 2> /dev/null

shopt -s nullglob
for key in "$agent_dir"/keys/*@${KEYCUTTER_ORIGIN:-"$(hostname -s)"}; do
    if [[ -f "$key" && "$key" != *.pub ]]; then
        ssh-add "$key" &>/dev/null
    fi
done
shopt -u nullglob
